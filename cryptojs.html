<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Crypto Decrypt</title>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
	<script src="http://cdn.rawgit.com/eligrey/FileSaver.js/master/FileSaver.js">/* note cannot run in web worker */</script>
	<!-- <script src="download.js"></script> -->
	<style>
	</style>
	<script>
		function ob(x){
			return document.getElementById(x);
		}
		function encrypt () {
			var text = ob('text').value;
			var key = ob('key').value;
			var encrypted = CryptoJS.AES.encrypt(text, key);
			ob('encrypted').value = encrypted.toString();
		}
		function decrypt() {
			var encrypted = ob('encrypted').value;
			var decrypted = CryptoJS.AES.decrypt(encrypted, ob('key').value);
			ob('decrypted').value = decrypted.toString(CryptoJS.enc.Utf8);
		}
	</script>
</head>
<body>
	<div class="container">
			<div class="form-group">
				<input type="text" id="text" class="form-control" placeholder="Text"/>
			</div>
			<div class="form-group">
				<input type="text" id="key" class="form-control" placeholder="Key"/>
			</div>
			<div class="form-group">
				<button class="btn btn-success" onclick="encrypt()">Encrypt</button>
			</div>
			<div class="form-group">
				<textarea id="encrypted" class="form-control"></textarea>
			</div>
			<div class="form-group">
				<button class="btn btn-success" onclick="decrypt()">Decrypt</button>
			</div>
			<div class="form-group">
				<input type="text" id="decrypted" class="form-control"/>
			</div>
			<div class="form-group">
				<input type="file" name="attach" id="attach" multiple>
				<textarea name="file-info" id="file-info" cols="30" rows="10"></textarea>
				<button class="btn btn-info" id="btnEncryptFile">Encrypt File</button>
				<button class="btn btn-info" id="btnDecryptFile">Decrypt File</button>
			</div>
			<script>
				function handleFileSelect (event) {
					var files = event.target.files;
					for (var i = 0; i < files.length; i++) {
						file = files[i];
						console.log(file);
					};

				}
				ob('attach').addEventListener('change', handleFileSelect, false);
				ob('btnDecryptFile').disabled = true;

				var tmpcipher = '';
				var tmpFileName = '';

				// Sync Functions

				function encryptFileSync () {
					var files = ob('attach').files;
					file = files[0];
					console.log('read File: ');
					console.log(file);
					tmpFileName = file.name;
					var reader = new FileReader();
					reader.onload = function (evt){
						// if (evt.target.readyState == FileReader.DONE){
						var encrypted = CryptoJS.AES.encrypt(evt.target.result, ob('key').value);
						a.attr('href', 'data:application/octet-stream,' + encrypted);
						a.attr('download', file.name + '.encrypted');
						// saveAs(new Blob([encrypted], {Type: 'application/octet-stream'}), file.name + '.encrypted');
						// ob('file-info').value = encrypted;
						tmpcipher = encrypted;
						console.log('encrypted');

					}
					// var blob = file.slice(0, file.size);
					reader.readAsDataURL(file);
				}

				function decryptFileSync () {
					var cipher = tmpcipher;
					var fileName = tmpFileName;
					var decrypted = CryptoJS.AES.decrypt(cipher, ob('key').value).toString(CryptoJS.enc.Latin1);
					console.log('start saving');
					saveAs(dataURLToBlob(decrypted), fileName);
					console.log('finish saving');
				}

				// Async Functions => Good

				function encryptFile (evt) {
					var files = ob('attach').files;
					file = files[0];
					tmpFileName = file.name;
					evt.target.disabled = true;
					evt.target.innerHTML = 'Encrypting...';
					if (typeof(Worker) !== 'undefined'){
						if (typeof(ew) == 'undefined'){
							ew = new Worker('file-worker.js');
							ew.postMessage({
								type: 'encrypt',
								file: file,
								key: ob('key').value
							});
						}
						ew.onmessage = function (event) {
							evt.target.disabled = false;
							evt.target.innerHTML = 'Encrypt File';
							ob('file-info').value = 'File has been encrypted.';
							ob('btnDecryptFile').disabled = false;
							tmpcipher = event.data.cipher;
							ew.terminate();
							ew = undefined;
						}
					}
					else{
						alert('Does not support web worker');
					}
				}

				ob('btnEncryptFile').addEventListener('click', encryptFile);

				function decryptFile (evt) {
					var cipher = tmpcipher;
					var fileName = tmpFileName;
					evt.target.disabled = true;
					evt.target.innerHTML = 'Decrypting...';
					if (typeof(Worker) !== 'undefined'){
						if (typeof(de) == 'undefined'){
							dw = new Worker('file-worker.js');
							dw.postMessage({
								type: 'decrypt',
								cipher: cipher,
								key: ob('key').value
							});
						}
						dw.onmessage = function (event) {
							var blob = undefined;
							try{
								blob = dataURLToBlob(event.data.dataURL);
								// console.log(evt.target);
								evt.target.disabled = false;
								evt.target.innerHTML = 'Decrypt File';
								saveAs(blob, fileName);
							}
							catch (e){
								alert('Key không đúng');
							}
							dw.terminate();
							dw = undefined;
						}
					}
				}

				// dataURLToBlob => get from https://github.com/ebidel/filer.js/blob/master/src/filer.js#L137
				var dataURLToBlob = function(dataURL) {
					var BASE64_MARKER = ';base64,';
					if (dataURL.indexOf(BASE64_MARKER) == -1) {
						var parts = dataURL.split(',');
						var contentType = parts[0].split(':')[1];
						var raw = decodeURIComponent(parts[1]);

						return new Blob([raw], {type: contentType});
					}

					var parts = dataURL.split(BASE64_MARKER);
					var contentType = parts[0].split(':')[1];
					var raw = window.atob(parts[1]);
					var rawLength = raw.length;

					var uInt8Array = new Uint8Array(rawLength);

					for (var i = 0; i < rawLength; ++i) {
					  uInt8Array[i] = raw.charCodeAt(i);
					}

					return new Blob([uInt8Array], {type: contentType});
				}

				ob('btnDecryptFile').addEventListener('click', decryptFile);
			</script>
	</div>
</body>
</html>