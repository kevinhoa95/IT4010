<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Crypto Decrypt</title>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
	<script src="http://cdn.rawgit.com/eligrey/FileSaver.js/master/FileSaver.js">/* note cannot run in web worker */</script>
	<script src="download.js"></script>
	<style>
	</style>
	<script>
		function ob(x){
			return document.getElementById(x);
		}
		function encrypt () {
			var text = ob('text').value;
			var key = ob('key').value;
			var encrypted = CryptoJS.AES.encrypt(text, key);
			ob('encrypted').value = encrypted.toString();
		}
		function decrypt() {
			var encrypted = ob('encrypted').value;
			var decrypted = CryptoJS.AES.decrypt(encrypted, ob('key').value);
			ob('decrypted').value = decrypted.toString(CryptoJS.enc.Utf8);
		}
	</script>
</head>
<body>
	<div class="container">
			<div class="form-group">
				<input type="text" id="text" class="form-control" placeholder="Text"/>
			</div>
			<div class="form-group">
				<input type="text" id="key" class="form-control" placeholder="Key"/>
			</div>
			<div class="form-group">
				<button class="btn btn-success" onclick="encrypt()">Encrypt</button>
			</div>
			<div class="form-group">
				<textarea id="encrypted" class="form-control"></textarea>
			</div>
			<div class="form-group">
				<button class="btn btn-success" onclick="decrypt()">Decrypt</button>
			</div>
			<div class="form-group">
				<input type="text" id="decrypted" class="form-control"/>
			</div>
			<div class="form-group">
				<input type="file" name="attach" id="attach" multiple>
				<textarea name="file-info" id="file-info" cols="30" rows="10"></textarea>
				<button class="btn btn-info" id="btnEncryptFile">Encrypt File</button>
				<button class="btn btn-info" id="btnDecryptFile">Decrypt File</button>
				<a class="btn btn-info" id="btnDownload">Download File</a>
			</div>
			<script>
				function handleFileSelect (event) {
					var files = event.target.files;
					for (var i = 0; i < files.length; i++) {
						file = files[i];
						console.log(file);
					};

				}
				ob('attach').addEventListener('change', handleFileSelect, false);
				a = $('#btnDownload');

				function encryptFile () {
					var files = ob('attach').files;
					file = files[0];
					console.log('read File: ');
					console.log(file);
					var reader = new FileReader();
					reader.onload = function (evt){
						// if (evt.target.readyState == FileReader.DONE){
						// 	// ob('file-info').value = ob('file-info').innerHTML = evt.target.result;
						// 	// ob('data').value = evt.target.result;
						// 	// console.log(evt.target.result);
						// 	// console.log(CryptoJS.AES.encrypt(evt.target.result, ob('key').value).toString());
						// saveAs(new Blob([unescape(encodeURIComponent(CryptoJS.AES.encrypt(evt.target.result, ob('key').value).toString()))], {Type: 'text/plain'}), file.name + '.encrypted');
						var encrypted = CryptoJS.AES.encrypt(evt.target.result, ob('key').value);
						a.attr('href', 'data:application/octet-stream,' + encrypted);
						a.attr('download', file.name + '.encrypted');
						saveAs(new Blob([encrypted], {Type: 'application/octet-stream'}), file.name + '.encrypted');

					}
					// var blob = file.slice(0, file.size);
					reader.readAsDataURL(file);
				}

				// function ab2str(buf) {
				// 	return String.fromCharCode.apply(null, new Uint8Array(buf));
				// }

				// http://www.movable-type.co.uk/scripts/aes.html
				// http://tutorialzine.com/2013/11/javascript-file-encrypter/

				ob('btnEncryptFile').addEventListener('click', encryptFile);

				function decryptFile () {
					var files = ob('attach').files;
					file = files[0];
					// console.log(file);
					var reader = new FileReader();
					reader.onload = function (evt){
						// saveAs(new Blob([CryptoJS.AES.decrypt(decodeURIComponent(escape(evt.target.result)), ob('key').value).toString(CryptoJS.enc.Latin1)], {Type: 'data:application/octet-stream'}), file.name.substring(0, file.name.indexOf('.encrypted')));
						// }
						var decrypted = CryptoJS.AES.decrypt(evt.target.result, ob('key').value).toString(CryptoJS.enc.Utf8);
						var mime = decrypted.substring(5, decrypted.indexOf(',') + 1);
						console.log(mime);
						// saveAs(new Blob([decrypted.substring(decrypted.indexOf(',') + 1)], {Type: mime}), file.name.replace('.encrypted',''));
						// document.location = decrypted;
						download(decrypted, file.name.replace('.encrypted', ''), mime);
						a.attr('href', decrypted);
						a.attr('download', file.name.replace('.encrypted',''));
					}
					// var blob = file.slice(0, file.size);
					reader.readAsText(file);
				}

				ob('btnDecryptFile').addEventListener('click', decryptFile);
			</script>
	</div>
</body>
</html>